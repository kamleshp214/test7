<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project K: System Core</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* --- DESIGN TOKENS --- */
        :root {
            /* Palette - Architectural/Brutalist */
            --bg-canvas: #F4F4F4;
            --bg-surface: #FFFFFF;
            --bg-inset: #FAFAFA;
            
            --ink-primary: #121212;
            --ink-secondary: #555555;
            --ink-tertiary: #999999;
            --ink-inverse: #FFFFFF;
            --ink-error: #B00020;
            
            --line-light: #E0E0E0;
            --line-medium: #CCCCCC;
            --line-heavy: #121212;
            
            --accent-core: #9A3B3B; /* Rust */
            --accent-wash: rgba(154, 59, 59, 0.08);
            --accent-hover: rgba(154, 59, 59, 0.12);
            --accent-error: #B00020;
            --accent-success: #2E7D32;
            --accent-audit: #D4A017;
            
            /* Typography */
            --font-display: 'Space Grotesk', system-ui, sans-serif;
            --font-technical: 'JetBrains Mono', monospace;
            --font-reading: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            
            /* Metrics */
            --spacing-unit: 8px;
            --tap-target: 48px; /* Strict Minimum */
            --radius-sharp: 2px;
            --radius-soft: 4px;
            
            /* Animation */
            --ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
            --ease-in-out: cubic-bezier(0.645, 0.045, 0.355, 1);
            --duration-fast: 150ms;
            --duration-normal: 300ms;
        }

        /* --- RESET & BASE --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* App-like behavior */
        }

        body {
            background-color: var(--bg-canvas);
            color: var(--ink-primary);
            font-family: var(--font-reading);
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            font-size: 16px; /* Base size for legibility */
        }

        /* --- TYPOGRAPHY SYSTEM --- */
        h1, h2, h3, h4 {
            font-family: var(--font-display);
            font-weight: 600;
            letter-spacing: -0.02em;
            margin: 0;
        }

        h1 { font-size: 1.5rem; }
        h2 { font-size: 1.25rem; }
        h3 { font-size: 1.1rem; }

        .text-mono { font-family: var(--font-technical); }
        
        .text-label {
            font-family: var(--font-technical);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--ink-secondary);
            margin-bottom: var(--spacing-unit);
            display: block;
        }
        
        .text-small { font-size: 0.85rem; color: var(--ink-secondary); }
        .text-micro { font-size: 0.7rem; color: var(--ink-tertiary); }

        /* --- LAYOUT SHELL --- */
        .app-shell {
            width: 100%;
            max-width: 700px;
            height: 100%;
            margin: 0 auto;
            background: var(--bg-surface);
            border-left: 1px solid var(--line-light);
            border-right: 1px solid var(--line-light);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.05);
        }

        /* --- SCROLLABLE VIEWPORT --- */
        .viewport {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        /* --- HEADER & GRID --- */
        .header-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--line-light);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .system-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-inset);
            border: 1px solid var(--line-light);
            font-size: 0.75rem;
            font-family: var(--font-technical);
            cursor: default;
            user-select: none;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--ink-tertiary);
            transition: background-color 0.3s;
        }
        .status-dot.active { background: var(--accent-success); box-shadow: 0 0 4px var(--accent-success); }
        .status-dot.error { background: var(--accent-error); box-shadow: 0 0 4px var(--accent-error); }
        .status-dot.audit { background: var(--accent-audit); }
        .status-dot.locked { background: var(--ink-secondary); }

        /* YEAR GRID (2026) */
        .year-grid-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* Prevent accidental scroll capture on mobile */
            touch-action: pan-x pan-y; 
        }

        .year-grid {
            display: grid;
            /* 53 weeks columns */
            grid-template-columns: repeat(53, 1fr);
            /* 7 days rows */
            grid-template-rows: repeat(7, 1fr);
            grid-auto-flow: column;
            gap: 2px;
            height: 90px; /* Slightly taller for touch */
            padding: 2px; /* Touch buffer */
        }

        .grid-cell {
            background: var(--bg-inset);
            border-radius: 1px;
            cursor: pointer;
            transition: opacity 0.1s;
            position: relative; /* For Pseudo-elements */
        }
        
        .grid-cell.pre-start { 
            opacity: 0.2; 
            pointer-events: none; 
            background: var(--line-light); 
        }
        
        .grid-cell.future { 
            opacity: 0.1; 
            pointer-events: none; 
            background: transparent; 
            border: 1px solid var(--line-light); 
        }
        
        .grid-cell.active-today { 
            border: 1px solid var(--ink-primary); 
            z-index: 2; 
            background: #FFF;
        }
        
        /* State Colors */
        .grid-cell[data-state="partial"] { background: var(--accent-wash); }
        .grid-cell[data-state="complete"] { background: var(--accent-core); }
        
        /* Touch feedback */
        .grid-cell:active { transform: scale(0.9); }

        /* --- PROTOCOL SECTION --- */
        .protocol-card {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        /* Focus Selector */
        .focus-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px; /* Larger gap for touch */
        }

        .focus-chip {
            padding: 10px 18px; /* Larger target */
            min-height: var(--tap-target);
            border: 1px solid var(--line-light);
            background: transparent;
            font-family: var(--font-technical);
            font-size: 0.85rem;
            color: var(--ink-secondary);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-out);
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .focus-chip:active { transform: scale(0.98); background: var(--bg-inset); }
        
        .focus-chip.selected { 
            background: var(--ink-primary); 
            color: var(--ink-inverse); 
            border-color: var(--ink-primary);
            font-weight: 500;
        }
        
        /* Visual Lock State */
        .focus-chip.locked-out { 
            opacity: 0.3; 
            pointer-events: none; 
            filter: grayscale(1); 
            border-style: dashed;
        }
        
        .focus-chip.locked-active {
            pointer-events: none;
            cursor: default;
            border-color: var(--accent-core);
            color: var(--accent-core);
            background: var(--bg-surface);
            font-weight: 700;
        }

        /* Visual Warning Animation */
        .warning-flash { animation: flashError 0.5s var(--ease-in-out); }
        @keyframes flashError {
            0%, 100% { border-color: var(--line-light); transform: translateX(0); }
            25% { transform: translateX(-4px); }
            50% { border-color: var(--accent-error); color: var(--accent-error); transform: translateX(4px); }
            75% { transform: translateX(-4px); }
        }

        /* Checklist */
        .checklist {
            display: flex;
            flex-direction: column;
            gap: 0;
            border-top: 1px solid var(--line-light);
        }

        .check-item {
            display: flex;
            align-items: flex-start; /* Align top for multiline */
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--line-light);
            cursor: pointer;
            transition: background var(--duration-fast);
            min-height: 64px; /* Generous touch target */
        }

        .check-item:active { background: var(--bg-inset); }
        
        .check-item.locked { 
            opacity: 0.4; 
            pointer-events: none; 
            cursor: not-allowed;
        }

        .checkbox-ui {
            width: 24px;
            height: 24px;
            margin-top: 2px; /* Optical alignment */
            border: 1.5px solid var(--ink-secondary);
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--duration-fast);
            flex-shrink: 0;
        }

        .check-item.checked .checkbox-ui {
            background: var(--accent-core);
            border-color: var(--accent-core);
        }

        .check-item.checked .checkbox-ui::after {
            content: '';
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            margin-bottom: 3px;
        }

        .check-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .check-label {
            font-size: 1rem;
            color: var(--ink-primary);
            transition: color var(--duration-fast);
            line-height: 1.4;
        }

        .check-item.checked .check-label {
            text-decoration: line-through;
            color: var(--ink-tertiary);
        }
        
        .time-badge {
            display: inline-block;
            font-family: var(--font-technical);
            font-size: 0.7rem;
            color: var(--ink-secondary);
            background: var(--bg-inset);
            padding: 2px 6px;
            border-radius: 2px;
            border: 1px solid var(--line-light);
            align-self: flex-start;
        }

        /* --- METRICS PANEL (Cold Facts) --- */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px; /* Borders via gap */
            background: var(--line-light);
            border: 1px solid var(--line-light);
        }

        .metric-box {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 24px;
            background: var(--bg-surface);
        }

        .metric-value {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--ink-primary);
            line-height: 1;
        }
        
        .metric-sub {
            font-family: var(--font-technical);
            font-size: 0.7rem;
            color: var(--ink-tertiary);
            margin-top: 4px;
        }

        /* --- SIDE PANEL (Journal) --- */
        .side-panel-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--duration-normal) var(--ease-out);
            backdrop-filter: blur(4px);
        }
        .side-panel-overlay.active { opacity: 1; pointer-events: all; }

        .side-panel {
            position: fixed;
            top: 0; right: 0; bottom: 0;
            width: 100%;
            max-width: 500px;
            background: var(--bg-surface);
            border-left: 1px solid var(--line-light);
            z-index: 101;
            transform: translateX(100%);
            transition: transform var(--duration-normal) var(--ease-out);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
        }
        .side-panel.open { transform: translateX(0); }

        .panel-header {
            padding: 24px;
            border-bottom: 1px solid var(--line-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-surface);
        }

        .panel-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            gap: 24px;
            overflow-y: auto;
            background: var(--bg-inset);
        }
        
        .panel-section-title {
            font-family: var(--font-technical);
            font-size: 0.75rem;
            color: var(--ink-secondary);
            font-weight: 600;
            border-bottom: 1px solid var(--line-medium);
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        /* Immutable Past Notes Styling */
        .past-notes-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .note-block {
            background: var(--bg-surface);
            padding: 12px 16px;
            border-left: 3px solid var(--line-medium);
            font-family: var(--font-technical);
            font-size: 0.85rem;
            color: var(--ink-secondary);
            white-space: pre-wrap;
        }
        
        .note-timestamp {
            font-size: 0.65rem;
            color: var(--ink-tertiary);
            margin-bottom: 4px;
            display: block;
        }

        /* Active Editor */
        .journal-editor {
            flex: 1;
            min-height: 200px;
            width: 100%;
            border: 1px solid var(--line-light);
            background: var(--bg-surface);
            padding: 16px;
            font-family: var(--font-technical);
            font-size: 0.95rem;
            line-height: 1.6;
            resize: none;
            border-radius: var(--radius-sharp);
            color: var(--ink-primary);
            transition: border-color 0.2s;
        }
        .journal-editor:focus {
            outline: none;
            border-color: var(--accent-core);
            box-shadow: 0 0 0 1px var(--accent-core);
        }

        .save-indicator {
            font-family: var(--font-technical);
            font-size: 0.75rem;
            color: var(--ink-tertiary);
            text-align: right;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px;
        }

        /* --- PRE-START STATE --- */
        .locked-state-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            text-align: center;
            gap: 32px;
            padding: 40px;
            background: var(--bg-inset);
            border: 1px dashed var(--line-light);
            margin: 24px 0;
        }
        .locked-icon { 
            color: var(--ink-tertiary); 
            background: var(--bg-surface);
            padding: 24px;
            border-radius: 50%;
            border: 1px solid var(--line-light);
        }
        .locked-msg { 
            font-family: var(--font-technical); 
            font-size: 0.95rem; 
            color: var(--ink-secondary); 
            max-width: 320px; 
            line-height: 1.6;
        }
        
        .countdown-timer {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 700;
            color: var(--ink-primary);
            margin-top: 16px;
        }

        /* --- FOOTER --- */
        .system-footer {
            margin-top: auto;
            padding-top: 40px;
            padding-bottom: 24px;
            text-align: center;
            border-top: 1px solid var(--line-light);
        }

    </style>
</head>
<body>

    <div class="app-shell">
        
        <!-- MAIN VIEWPORT -->
        <div class="viewport" id="main-view">
            <!-- Header -->
            <div class="header-section">
                <div class="header-top">
                    <h1>PROJECT K</h1>
                    <div class="system-status" id="sys-status-indicator">
                        <span id="integrity-dot" class="status-dot active"></span>
                        <span id="integrity-msg" class="text-mono">SYS OK</span>
                    </div>
                </div>
                <div class="text-label" id="current-date-display">CALCULATING DATE...</div>
                
                <!-- Year Grid -->
                <div class="year-grid-wrapper">
                    <div class="year-grid" id="calendar-root"></div>
                </div>
                <div class="text-micro text-mono" style="text-align: right; margin-top: 4px;">
                    START: 2026-02-05
                </div>
            </div>

            <!-- DYNAMIC CONTENT AREA -->
            <div id="dynamic-content">
                <!-- Content injected by View Engine -->
            </div>

            <!-- Footer / Integrity -->
            <div class="system-footer">
                <div class="text-mono text-small" style="font-size: 0.6rem; color: var(--ink-tertiary);">
                    v4.1.0 // SECURE RECORD // IMMUTABLE HISTORY
                </div>
            </div>
        </div>

    </div>

    <!-- SIDE PANEL -->
    <div class="side-panel-overlay" id="panel-overlay"></div>
    <div class="side-panel" id="side-panel">
        <div class="panel-header">
            <div>
                <div class="text-label">JOURNAL & LOG</div>
                <div class="text-mono text-small" id="panel-date-display">...</div>
            </div>
            <button id="panel-close" style="background:none; border:none; padding:12px; cursor:pointer; color: var(--ink-primary);">
                <i data-feather="x"></i>
            </button>
        </div>
        <div class="panel-body">
            <!-- Context Info -->
            <div>
                <div class="panel-section-title">DAILY CONTEXT</div>
                <div class="text-small text-mono" id="panel-context-info">Focus: ...</div>
            </div>

            <!-- Immutable History (Past Notes) -->
            <div id="panel-history-section" style="display: none;">
                <div class="panel-section-title">PREVIOUS ENTRIES</div>
                <div id="panel-past-notes" class="past-notes-container"></div>
            </div>

            <!-- Active Editor -->
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div class="panel-section-title" id="editor-label">NEW ENTRY</div>
                <textarea class="journal-editor" id="journal-input" placeholder="Log execution details, errors, and insights..."></textarea>
                <div class="save-indicator" id="save-status">
                    <i data-feather="cloud" style="width: 12px; height: 12px;"></i> Synced
                </div>
            </div>
        </div>
    </div>

    <!-- TEMPLATES -->
    <template id="tpl-locked">
        <div class="locked-state-view">
            <div class="locked-icon"><i data-feather="lock" style="width: 48px; height: 48px;"></i></div>
            <h2>SYSTEM LOCKED</h2>
            <p class="locked-msg">
                Protocol enforcement begins strictly on <span class="text-mono" style="color:var(--ink-primary); font-weight:600">2026-02-05</span>.
                <br><br>
                No actions are permitted before the contract start date.
            </p>
            <div id="countdown-display" class="countdown-timer">-- days</div>
            <div class="text-label" style="margin-top: 24px; color: var(--accent-core);">PREPARATION PHASE</div>
        </div>
    </template>

    <template id="tpl-active">
        <div class="protocol-card">
            
            <!-- Focus Section -->
            <div>
                <div class="text-label">DAILY FOCUS INTENT</div>
                <div class="focus-group" id="focus-render-target"></div>
                <div class="text-micro text-mono" style="margin-top: 8px; color: var(--ink-tertiary);" id="focus-lock-status">
                    * Selection locks upon first action
                </div>
            </div>

            <!-- Checklist Section -->
            <div>
                <div class="text-label">EXECUTION SEQUENCE</div>
                <div class="checklist" id="checklist-render-target"></div>
            </div>

            <!-- Metrics (Bottom) -->
            <div>
                <div class="text-label">PERFORMANCE AUDIT</div>
                <div class="metrics-grid">
                    <div class="metric-box">
                        <div class="text-label">EXECUTION RATIO</div>
                        <div class="metric-value" id="metric-ratio">0%</div>
                        <div class="metric-sub" id="metric-ratio-detail">0/0 Days</div>
                    </div>
                    <div class="metric-box">
                        <div class="text-label">PERFECT RUN</div>
                        <div class="metric-value" id="metric-streak">0</div>
                        <div class="metric-sub" id="metric-streak-detail">Current Streak</div>
                    </div>
                    <div class="metric-box">
                        <div class="text-label">INCONSISTENCY</div>
                        <div class="metric-value" id="metric-missed" style="color: var(--accent-error)">0</div>
                        <div class="metric-sub">Days Missed</div>
                    </div>
                    <div class="metric-box">
                        <div class="text-label">TOTAL LOGS</div>
                        <div class="metric-value" id="metric-total">0</div>
                        <div class="metric-sub">System Events</div>
                    </div>
                </div>
            </div>

        </div>
    </template>

    <script>
        /**
         * PROJECT K: JAVA MASTERY - SYSTEM CORE v4.1.0
         * * PRINCIPLES:
         * 1. TRUTH: Date logic is absolute. Feb 5, 2026 is Day 0.
         * 2. INTEGRITY: State is hashed and audited. Corruption triggers safety modes.
         * 3. DISCIPLINE: Sequential execution. Focus locking. Append-only journals.
         * * ARCHITECTURE:
         * - DateEngine: Time authority.
         * - IntegritySystem: Security and validation.
         * - StateStore: Persistence and transactions.
         * - DomainLogic: Business rules.
         * - ViewEngine: UI Rendering.
         * - ActionController: User intent handling.
         */

        /* --- 1. CONFIGURATION --- */
        const CONFIG = {
            START_DATE: "2026-02-05", // ABSOLUTE START DATE
            STORAGE_KEY: "project_k_master_v4_1",
            FOCUS_AREAS: ['Collections', 'OOP', 'Streams', 'Concurrency', 'System Design'],
            CHECKLIST: [
                { id: 'c1', text: "Warm-up: 3 CodingBat Problems", time: "15m" },
                { id: 'c2', text: "Core: Deep Dive Video Session", time: "45m" },
                { id: 'c3', text: "Practice: 1 HackerRank Challenge", time: "30m" },
                { id: 'c4', text: "Review: Explain Logic Aloud", time: "10m" },
                { id: 'c5', text: "System: Log Entry & Commit", time: "5m" }
            ]
        };

        /* --- 2. DATE ENGINE (THE TRUTH) --- */
        const DateEngine = {
            // Returns YYYY-MM-DD for user's local time
            getToday: () => {
                const d = new Date();
                const offset = d.getTimezoneOffset() * 60000;
                return new Date(d.getTime() - offset).toISOString().split('T')[0];
            },

            // Returns pure date object from string (00:00:00 local)
            parse: (str) => {
                const parts = str.split('-');
                return new Date(parts[0], parts[1] - 1, parts[2]);
            },

            format: (str) => {
                const d = DateEngine.parse(str);
                return d.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }).toUpperCase();
            },

            formatISO: (ts) => {
                return new Date(ts).toISOString();
            },

            // Generate grid data: 371 days (53 weeks * 7 days) starting from start-of-week of Start Date
            getGridRange: () => {
                const start = DateEngine.parse(CONFIG.START_DATE);
                // Align to Sunday
                const gridStart = new Date(start);
                gridStart.setDate(start.getDate() - start.getDay());
                
                const days = [];
                for (let i = 0; i < 371; i++) {
                    const d = new Date(gridStart);
                    d.setDate(gridStart.getDate() + i);
                    days.push(d.toISOString().split('T')[0]);
                }
                return days;
            },

            getDaysUntilStart: () => {
                const start = DateEngine.parse(CONFIG.START_DATE);
                const today = DateEngine.parse(DateEngine.getToday());
                const diffTime = start - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            },

            isPreStart: (dateStr) => dateStr < CONFIG.START_DATE,
            isFuture: (dateStr) => dateStr > DateEngine.getToday(),
            isToday: (dateStr) => dateStr === DateEngine.getToday()
        };

        /* --- 3. INTEGRITY SYSTEM (INVISIBLE DISCIPLINE) --- */
        const Integrity = {
            
            // Simple hash for state verification
            hash: (str) => {
                let hash = 0, i, chr;
                if (str.length === 0) return hash;
                for (i = 0; i < str.length; i++) {
                    chr = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + chr;
                    hash |= 0; // Convert to 32bit integer
                }
                return hash.toString();
            },

            audit: (state) => {
                // 1. Check for future completion (Impossible state)
                const today = DateEngine.getToday();
                let violations = [];
                
                Object.keys(state.history).forEach(date => {
                    if (date > today && state.history[date].checklist.length > 0) {
                        violations.push({ type: "FUTURE_MODIFICATION", date });
                        delete state.history[date]; // Auto-repair: Delete impossible future data
                    }
                });

                // 2. Check Sequence Validity in History
                Object.keys(state.history).forEach(date => {
                    const entry = state.history[date];
                    if (entry.checklist && entry.checklist.length > 0) {
                        // Ensure no gaps
                        const indices = entry.checklist.map(id => CONFIG.CHECKLIST.findIndex(i => i.id === id)).sort((a,b) => a-b);
                        for (let i = 0; i < indices.length; i++) {
                            if (indices[i] !== i) {
                                violations.push({ type: "SEQUENCE_GAP", date });
                                // Auto-repair: Reset invalid day
                                entry.checklist = [];
                                entry.focusLocked = false;
                                break;
                            }
                        }
                    }
                });

                // 3. Schema & Hash Check (Basic)
                if (!state.meta || !state.meta.created) {
                    violations.push({ type: "SCHEMA_MISSING" });
                    state.meta = { created: Date.now(), version: 4 };
                }

                if (violations.length > 0) {
                    Integrity.report("AUDIT_FAILURE", violations);
                    return false;
                }
                return true;
            },

            report: (code, details) => {
                console.warn(`[AUDIT] ${code}`, details);
                // Visual Indicator
                const dot = document.getElementById('integrity-dot');
                const msg = document.getElementById('integrity-msg');
                if(dot) {
                    dot.className = "status-dot audit";
                    msg.textContent = "AUDIT";
                }
            }
        };

        /* --- 4. STATE STORE --- */
        const Store = {
            data: {
                meta: { version: 4, created: Date.now(), lastHash: "" },
                history: {}, // "YYYY-MM-DD": { focus:Str, focusLocked:Bool, checklist:[ids], notes:[{ts, text}] }
                events: []   // Audit Log: { ts, type, details }
            },

            init: () => {
                const raw = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (raw) {
                    try {
                        const parsed = JSON.parse(raw);
                        Store.data = parsed;
                        Integrity.audit(Store.data);
                    } catch (e) {
                        Integrity.report("CORRUPTION_RESET", e);
                        // In production, we might backup. Here, we enforce strictness.
                        // However, preserving notes is kind. We will try to salvage.
                        // If totally failed, reset.
                        Store.reset();
                    }
                } else {
                    Store.reset();
                }
                
                // Ensure today exists if allowed
                const today = DateEngine.getToday();
                if (!DateEngine.isPreStart(today) && !Store.data.history[today]) {
                    Store.createEntry(today);
                }
            },

            reset: () => {
                Store.data = {
                    meta: { version: 4, created: Date.now(), lastHash: "" },
                    history: {},
                    events: []
                };
                Store.save();
            },

            createEntry: (date) => {
                Store.data.history[date] = { 
                    focus: null, 
                    focusLocked: false, 
                    checklist: [], 
                    notes: [] // Array of {ts, text} for immutable appending
                };
            },

            save: () => {
                const json = JSON.stringify(Store.data);
                Store.data.meta.lastHash = Integrity.hash(json); // Sign the state
                localStorage.setItem(CONFIG.STORAGE_KEY, json);
            },

            // Get immutable copy of entry
            getEntry: (date) => {
                if (!Store.data.history[date]) return null;
                // Deep copy to prevent mutation outside Store
                return JSON.parse(JSON.stringify(Store.data.history[date]));
            },

            // Transactional update for Today ONLY
            updateToday: (callback) => {
                const today = DateEngine.getToday();
                if (DateEngine.isPreStart(today)) return; // Lockout
                
                if (!Store.data.history[today]) {
                    Store.createEntry(today);
                }
                
                // execute mutation
                callback(Store.data.history[today]);
                
                // Check focus lock condition automatically
                const entry = Store.data.history[today];
                if (entry.checklist.length > 0 && !entry.focusLocked) {
                    entry.focusLocked = true;
                    Store.logEvent("FOCUS_LOCKED", { date: today, focus: entry.focus });
                }

                Store.save();
                View.render(); // Global Re-render
            },

            // Append-only Note Logic
            appendNote: (date, text) => {
                if (!Store.data.history[date]) {
                    if (DateEngine.isFuture(date)) return;
                    Store.createEntry(date);
                }
                
                // Push new block
                const noteBlock = {
                    ts: Date.now(),
                    text: text.trim()
                };
                
                // Avoid empty appends
                if (noteBlock.text.length === 0) return;

                Store.data.history[date].notes.push(noteBlock);
                Store.save();
            },

            logEvent: (type, details) => {
                Store.data.events.push({
                    ts: Date.now(),
                    type: type,
                    details: details
                });
                // Keep log size managed? Maybe later. For now, infinite log for "Record Reality".
            }
        };

        /* --- 5. DOMAIN LOGIC --- */
        const Domain = {
            // Is focus selection permitted?
            canChangeFocus: (entry) => {
                return !entry.focusLocked;
            },

            // Checklist Logic
            canCheck: (entry, index) => {
                // Requirement: Strictly sequential
                // Can check index N if:
                // 1. Focus is selected
                // 2. Index N-1 is checked (or N=0)
                
                if (!entry.focus) return { allowed: false, reason: "NO_FOCUS" };
                
                const id = CONFIG.CHECKLIST[index].id;
                const isChecked = entry.checklist.includes(id);

                // Check if already checked (Uncheck logic)
                if (isChecked) {
                    // Allowed to uncheck, but warns about sequence breaking?
                    // "Undoing a checkbox logs an incomplete event"
                    return { allowed: true, action: "uncheck" };
                }

                // Sequential check
                if (index > 0) {
                    const prevId = CONFIG.CHECKLIST[index - 1].id;
                    if (!entry.checklist.includes(prevId)) return { allowed: false, reason: "SEQUENCE" };
                }
                
                return { allowed: true, action: "check" };
            },

            calculateMetrics: () => {
                const history = Store.data.history;
                const start = DateEngine.parse(CONFIG.START_DATE);
                const today = DateEngine.parse(DateEngine.getToday());
                
                let stats = {
                    totalDays: 0,
                    executedDays: 0,
                    missedDays: 0,
                    perfectRun: 0,
                    currentRun: 0,
                    totalLogs: Store.data.events.length
                };

                if (today < start) return stats; // No metrics pre-start

                // Calculate total days including today
                const diffTime = Math.abs(today - start);
                stats.totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                let tempStreak = 0;

                // Iterate day by day from start to today
                for (let i = 0; i < stats.totalDays; i++) {
                    const d = new Date(start);
                    d.setDate(start.getDate() + i);
                    const str = d.toISOString().split('T')[0];
                    const entry = history[str];
                    
                    const isPerfect = entry && entry.checklist.length === CONFIG.CHECKLIST.length;
                    
                    if (isPerfect) {
                        stats.executedDays++;
                        tempStreak++;
                    } else {
                        // Only count as missed if it's in the past. Today isn't missed until tomorrow.
                        if (str !== DateEngine.getToday()) {
                            stats.missedDays++;
                        }
                        tempStreak = 0;
                    }

                    if (tempStreak > stats.perfectRun) stats.perfectRun = tempStreak;
                }
                stats.currentRun = tempStreak;

                return stats;
            }
        };

        /* --- 6. VIEW ENGINE --- */
        const View = {
            init: () => {
                // Bind Global Events
                document.getElementById('panel-close').addEventListener('click', Panel.close);
                document.getElementById('panel-overlay').addEventListener('click', Panel.close);
                
                // Keyboard Shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') Panel.close();
                    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                        // Quick save logic if panel open
                        if (document.getElementById('side-panel').classList.contains('open')) {
                            const val = document.getElementById('journal-input').value;
                            if (val) {
                                Panel.save(val);
                                document.getElementById('journal-input').value = ""; // clear after save
                            }
                        }
                    }
                });

                // Initial Render
                View.render();
            },

            render: () => {
                const today = DateEngine.getToday();
                
                // 1. Header Date
                document.getElementById('current-date-display').textContent = DateEngine.format(today);

                // 2. Year Grid
                View.renderGrid();

                // 3. Dynamic Content
                const contentArea = document.getElementById('dynamic-content');
                if (DateEngine.isPreStart(today)) {
                    // Locked View
                    View.renderLocked(contentArea);
                } else {
                    // Active Protocol
                    View.renderActive(contentArea, today);
                }
            },

            renderLocked: (container) => {
                container.innerHTML = '';
                const tpl = document.getElementById('tpl-locked');
                container.appendChild(tpl.content.cloneNode(true));
                
                // Countdown
                const daysLeft = DateEngine.getDaysUntilStart();
                const el = document.getElementById('countdown-display');
                if (el) el.textContent = `T-MINUS ${daysLeft} DAYS`;
            },

            renderActive: (container, today) => {
                container.innerHTML = '';
                const tpl = document.getElementById('tpl-active');
                container.appendChild(tpl.content.cloneNode(true));
                
                const entry = Store.getEntry(today) || { focus: null, focusLocked: false, checklist: [] };
                View.renderProtocol(entry);
            },

            renderGrid: () => {
                const root = document.getElementById('calendar-root');
                // Optimization: Don't destroy if exists, just update?
                // For simplicity and strict state reflection, we rebuild. 
                // Grid is small enough (371 nodes).
                root.innerHTML = ''; 

                const days = DateEngine.getGridRange();
                const today = DateEngine.getToday();

                days.forEach(dateStr => {
                    const el = document.createElement('div');
                    el.className = 'grid-cell';
                    
                    // State Classes
                    if (DateEngine.isPreStart(dateStr)) el.classList.add('pre-start');
                    else if (DateEngine.isFuture(dateStr)) el.classList.add('future');
                    if (dateStr === today) el.classList.add('active-today');

                    // Data State
                    const entry = Store.getEntry(dateStr); // Use Store method which handles nulls
                    if (entry) {
                        if (entry.checklist.length === CONFIG.CHECKLIST.length) {
                            el.dataset.state = 'complete';
                        } else if (entry.checklist.length > 0) {
                            el.dataset.state = 'partial';
                        }
                    }

                    // Interaction
                    // Allow tapping Pre-start/Future? Prompt says "Future and pre-start cells remain non-interactive."
                    if (!DateEngine.isFuture(dateStr) && !DateEngine.isPreStart(dateStr)) {
                        el.onclick = () => Panel.open(dateStr);
                    }

                    root.appendChild(el);
                });
            },

            renderProtocol: (entry) => {
                // Focus
                const focusRoot = document.getElementById('focus-render-target');
                const isLocked = !Domain.canChangeFocus(entry);
                
                if (isLocked) {
                    document.getElementById('focus-lock-status').textContent = "LOCKED: Execution in progress";
                    document.getElementById('focus-lock-status').style.color = "var(--accent-core)";
                }

                focusRoot.innerHTML = CONFIG.FOCUS_AREAS.map(f => {
                    const isSelected = entry.focus === f;
                    let classes = 'focus-chip';
                    
                    if (isSelected) {
                        if (isLocked) classes += ' locked-active';
                        else classes += ' selected';
                    } else {
                        if (isLocked) classes += ' locked-out';
                    }
                    
                    // Only attach click if not locked
                    const clickAttr = isLocked ? '' : `onclick="ActionController.selectFocus('${f}')"`;
                    
                    return `<button class="${classes}" ${clickAttr}>${f}</button>`;
                }).join('');

                // Checklist
                const listRoot = document.getElementById('checklist-render-target');
                listRoot.innerHTML = CONFIG.CHECKLIST.map((item, idx) => {
                    const isChecked = entry.checklist.includes(item.id);
                    const lockStatus = Domain.canCheck(entry, idx);
                    
                    let classes = 'check-item';
                    if (isChecked) classes += ' checked';
                    if (!lockStatus.allowed && !isChecked) classes += ' locked';

                    // Onclick logic handled via Controller
                    return `
                        <div class="${classes}" onclick="ActionController.toggleCheck(${idx})">
                            <div class="checkbox-ui"></div>
                            <div class="check-content">
                                <span class="check-label">${item.text}</span>
                                <div class="time-badge">${item.time}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Metrics
                const stats = Domain.calculateMetrics();
                const ratio = stats.totalDays > 0 ? Math.round((stats.executedDays / stats.totalDays) * 100) : 0;
                
                document.getElementById('metric-ratio').textContent = `${ratio}%`;
                document.getElementById('metric-ratio-detail').textContent = `${stats.executedDays}/${stats.totalDays} Days`;
                
                document.getElementById('metric-streak').textContent = stats.currentRun;
                
                document.getElementById('metric-missed').textContent = stats.missedDays;
                document.getElementById('metric-total').textContent = stats.totalLogs;
            }
        };

        /* --- 7. ACTION CONTROLLER --- */
        const ActionController = {
            selectFocus: (focus) => {
                Store.updateToday(entry => {
                    // Double check Domain rules inside transaction
                    if (!Domain.canChangeFocus(entry)) {
                        Store.logEvent("FOCUS_CHANGE_ATTEMPT", { from: entry.focus, to: focus, denied: true });
                        // Visual Warning
                        const el = document.getElementById('focus-render-target');
                        el.classList.remove('warning-flash');
                        void el.offsetWidth;
                        el.classList.add('warning-flash');
                        return;
                    }
                    entry.focus = focus;
                    Store.logEvent("FOCUS_SELECTED", { focus });
                });
            },

            toggleCheck: (index) => {
                Store.updateToday(entry => {
                    const status = Domain.canCheck(entry, index);
                    const item = CONFIG.CHECKLIST[index];

                    if (!status.allowed) {
                        Store.logEvent("INVALID_CHECK_ATTEMPT", { index, reason: status.reason });
                        // Visual Warning
                        const el = document.getElementById('checklist-render-target');
                        el.classList.remove('warning-flash');
                        void el.offsetWidth;
                        el.classList.add('warning-flash');
                        return;
                    }

                    if (status.action === 'check') {
                        entry.checklist.push(item.id);
                        Store.logEvent("ITEM_COMPLETED", { id: item.id });
                    } else {
                        // Uncheck Logic (Waterfall)
                        // "Undoing a checkbox logs an 'incomplete' event"
                        // Strictly remove this item and any subsequent items to maintain sequence validity
                        const idsToRemove = [];
                        
                        // We need to remove the clicked item, AND any item that appears *after* it in the sequence
                        const clickedIndex = index;
                        
                        // Rebuild checklist keeping only items strictly before this index
                        // This implies if I uncheck step 2, step 3 is also unchecked.
                        const validIds = CONFIG.CHECKLIST.slice(0, clickedIndex).map(i => i.id);
                        
                        // Find what we are removing
                        const removed = entry.checklist.filter(id => !validIds.includes(id));
                        
                        entry.checklist = entry.checklist.filter(id => validIds.includes(id));
                        
                        Store.logEvent("ITEM_UNDONE", { removedIds: removed });
                    }
                });
            }
        };

        /* --- 8. PANEL LOGIC (JOURNAL) --- */
        const Panel = {
            activeDate: null,

            open: (dateStr) => {
                Panel.activeDate = dateStr;
                const entry = Store.getEntry(dateStr);
                
                document.getElementById('panel-date-display').textContent = DateEngine.format(dateStr);
                
                // Context Info
                const contextEl = document.getElementById('panel-context-info');
                if (entry) {
                    const pct = Math.round((entry.checklist.length / CONFIG.CHECKLIST.length) * 100);
                    contextEl.textContent = `FOCUS: ${entry.focus || 'NONE'} // PROGRESS: ${pct}%`;
                } else {
                    contextEl.textContent = "NO DATA";
                }

                // Render History (Immutable Past Notes)
                const historySection = document.getElementById('panel-history-section');
                const pastNotesContainer = document.getElementById('panel-past-notes');
                pastNotesContainer.innerHTML = '';

                if (entry && entry.notes && entry.notes.length > 0) {
                    historySection.style.display = 'block';
                    entry.notes.forEach(note => {
                        const div = document.createElement('div');
                        div.className = 'note-block';
                        // Format Timestamp
                        const time = new Date(note.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        div.innerHTML = `<span class="note-timestamp">${time}</span>${note.text}`;
                        pastNotesContainer.appendChild(div);
                    });
                } else {
                    historySection.style.display = 'none';
                }

                // Clear Editor for new input
                document.getElementById('journal-input').value = "";
                
                // If future, disable editor
                if (DateEngine.isFuture(dateStr)) {
                    document.getElementById('journal-input').disabled = true;
                    document.getElementById('journal-input').placeholder = "Future date locked.";
                } else {
                    document.getElementById('journal-input').disabled = false;
                    document.getElementById('journal-input').placeholder = "Append new log entry...";
                }
                
                document.getElementById('panel-overlay').classList.add('active');
                document.getElementById('side-panel').classList.add('open');
                
                // Auto-focus if not future
                if (!DateEngine.isFuture(dateStr)) {
                    setTimeout(() => document.getElementById('journal-input').focus(), 300);
                }
            },

            close: () => {
                document.getElementById('panel-overlay').classList.remove('active');
                document.getElementById('side-panel').classList.remove('open');
                Panel.activeDate = null;
                // Force blur to hide mobile keyboard
                document.getElementById('journal-input').blur();
            },

            save: (text) => {
                if(!Panel.activeDate) return;
                if(!text || text.trim() === "") return;

                Store.appendNote(Panel.activeDate, text);
                
                // UI Feedback
                document.getElementById('save-status').innerHTML = `<i data-feather="check" style="width:12px"></i> Synced ${new Date().toLocaleTimeString()}`;
                
                // Re-render the panel to show the new note in the "Previous Entries" section immediately
                // This gives the "Append Only" feel
                Panel.open(Panel.activeDate); 
            }
        };

        /* --- BOOTSTRAP --- */
        (function() {
            try {
                // Initialize Feather Icons
                feather.replace();
                
                // Initialize System
                Store.init();
                View.init();
                
                console.log("PROJECT K // SYSTEM ONLINE");
            } catch (e) {
                console.error("System Failure", e);
                document.body.innerHTML = `
                    <div style="padding:40px; color:var(--accent-error); text-align:center; font-family:monospace;">
                        <h1>SYSTEM INTEGRITY FAILURE</h1>
                        <p>Check console for stack trace.</p>
                        <p>${e.message}</p>
                    </div>
                `;
            }
        })();

    </script>
</body>
</html>
